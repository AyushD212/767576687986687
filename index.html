<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Redirect Generator</title>
<style>
html,body {
  height:100%; margin:0; padding:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#f8f9fa; color:#111;
}
.section {
  border:1px solid #e0e0e0; padding:14px; border-radius:8px;
  margin:18px auto; max-width:960px; background:#fff;
}
input[type="text"] {
  width:72%; padding:8px; border:1px solid #ccc; border-radius:4px;
}
button {
  padding:8px 12px; border-radius:6px; border:0;
  background:#0366d6; color:#fff; cursor:pointer;
}
.sample { word-break:break-all; color:#0366d6; text-decoration:none; }
#verify-screen {
  display:none; align-items:center; justify-content:center;
  height:100vh; background:#f8f9fa;
}
#verify-box {
  background:#fff; padding:30px; border-radius:10px;
  box-shadow:0 4px 16px rgba(0,0,0,0.1); text-align:center;
}
h2 { font-weight:500; margin-bottom:14px; }
</style>

<!-- Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
// ------------------ CONFIG ------------------
const CONFIG = {
  PUBLIC_HOST: window.location.origin + '/', 
  TURNSTILE_SITE_KEY: 'YOUR_TURNSTILE_SITE_KEY', // <---- REPLACE YOUR KEY
};

// ------------------ CRYPTO UTILITIES ------------------
function safeBtoa(str){ try{return btoa(str);}catch(e){return btoa(unescape(encodeURIComponent(str)));} }
function safeAtob(s){ try{return atob(s);}catch(e){try{return decodeURIComponent(escape(atob(s)));}catch(e2){return null;}} }
function uuid(){ return crypto.randomUUID ? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2,12); }
function generateRandomWords(count=2){
  const words=["forest","river","mountain","star","moon","cloud","leaf","stone","sun","wave","sky","tree","spark","crystal"];
  let result=[];
  for(let i=0;i<count;i++) result.push(words[Math.floor(Math.random()*words.length)] + '-' + Math.random().toString(36).slice(2,4));
  return result.join('/');
}

// ------------------ LINK GENERATION ------------------
function generateLink(){
  const dest=document.getElementById('targetInput').value.trim();
  if(!dest) return alert('Enter a destination URL.');
  
  // Auto-generate per-link secret
  const SECRET_KEY=crypto.getRandomValues(new Uint8Array(32));
  const HMAC_KEY=crypto.getRandomValues(new Uint8Array(32));
  
  const payload={u:dest,r:uuid(),t:Date.now(),s:Array.from(SECRET_KEY),h:Array.from(HMAC_KEY)};
  const encoded=safeBtoa(JSON.stringify(payload));
  const randomPath=generateRandomWords();
  const final=`${CONFIG.PUBLIC_HOST}${randomPath}/${encoded}`;
  
  document.getElementById('generated').innerHTML=
    `<div><strong>Encoded link:</strong><br/><a class="sample" href="${final}" target="_blank">${final}</a></div>`;
}

// ------------------ VERIFY FLOW ------------------
window.addEventListener('DOMContentLoaded',()=>{
  const pathParts=location.pathname.split('/').filter(Boolean);
  if(pathParts.length<2){
    document.getElementById('generator').style.display='block';
    return;
  }

  const encoded=pathParts.pop(); // last segment is payload
  const decoded=safeAtob(decodeURIComponent(encoded));
  let payload;
  try{payload=JSON.parse(decoded);}catch(e){payload={u:decoded};}
  if(!payload||!payload.u){
    document.body.innerHTML='<p style="text-align:center;color:red;">Invalid or malformed link.</p>';
    return;
  }

  const dest=payload.u;
  document.getElementById('verify-screen').style.display='flex';
  const btn=document.getElementById('continueBtn');
  let verified=false;

  window.onTurnstileSuccess=function(token){
    verified=true;
    btn.disabled=false;
    btn.textContent='Continue';
  };

  btn.addEventListener('click',()=>{
    if(!verified){ alert('Please complete the verification first.'); return; }
    btn.disabled=true;
    btn.textContent='Redirecting...';
    setTimeout(()=>window.location.href=dest,500);
  });

  // Random page title
  const titles=["Explore New Horizons","Hidden Journey","Mystery Path","Secret Portal","Adventure Awaits","The Unknown"];
  document.title=titles[Math.floor(Math.random()*titles.length)];
});
</script>
</head>
<body>

<div id="generator" class="section" style="display:none;">
  <h2>Generate an encoded redirect link</h2>
  <input id="targetInput" type="text" placeholder="Enter destination URL (e.g. https://example.com)" />
  <button onclick="generateLink()">Generate</button>
  <div id="generated" style="margin-top:12px;"></div>
</div>

<div id="verify-screen">
  <div id="verify-box">
    <h2>Verify to Continue</h2>
    <div class="cf-turnstile" data-sitekey="YOUR_TURNSTILE_SITE_KEY" data-callback="onTurnstileSuccess"></div>
    <button id="continueBtn" disabled>Waiting for verification...</button>
  </div>
</div>

</body>
</html>
