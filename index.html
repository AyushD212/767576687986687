<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Secure Redirect</title>

<!-- Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<style>
body,html{margin:0;padding:0;background:#f8f9fa;font-family:Arial}
.box{background:#fff;max-width:900px;margin:30px auto;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
input[type=text]{padding:8px;width:70%;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;border:0;background:#0366d6;color:#fff;border-radius:6px;cursor:pointer}
a{color:#0366d6;word-break:break-all}
#verify{display:none;align-items:center;justify-content:center;height:100vh}
#vBox{background:#fff;padding:30px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.1);text-align:center}
</style>

<script>
(()=>{
const enc = new TextEncoder();
const dec = new TextDecoder();

const SITE = window.location.origin + window.location.pathname;
const TURNSTILE_SITE_KEY = "0x4AAAAAAB_GRO5x_mAh22NL";

/* ---------------- AES helpers ---------------- */
async function genKey(){ return crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt","decrypt"]); }
function b64(a){ return btoa(String.fromCharCode(...new Uint8Array(a))); }
function b64ToA(b){ return Uint8Array.from(atob(b),c=>c.charCodeAt(0)); }

/* --------- Encrypt full payload -------- */
async function encryptPayload(obj){
    obj.pad = crypto.getRandomValues(new Uint8Array(16));
    obj.noise = Math.random().toString(36).slice(2);
    obj.domain = location.hostname;
    obj.ts = Date.now();

    const k1 = await genKey();
    const iv1 = crypto.getRandomValues(new Uint8Array(12));
    const e1 = await crypto.subtle.encrypt({name:"AES-GCM",iv:iv1},k1,enc.encode(JSON.stringify(obj)));
    const rk1 = await crypto.subtle.exportKey("raw",k1);

    const k2 = await genKey();
    const iv2 = crypto.getRandomValues(new Uint8Array(12));
    const e2 = await crypto.subtle.encrypt({name:"AES-GCM",iv:iv2},k2,e1);
    const rk2 = await crypto.subtle.exportKey("raw",k2);

    return [
        btoa(b64(e2)),
        btoa(b64(iv2)),
        btoa(b64(rk2)),
        btoa(b64(iv1)),
        btoa(b64(rk1))
    ].join(".");
}

/* --------- Decrypt full payload -------- */
async function decryptPayload(str){
    try{
        let p = str.split(".").map(x=>atob(x));
        let [sE2,sIV2,sK2,sIV1,sK1] = p;

        let K2 = await crypto.subtle.importKey("raw",b64ToA(sK2),"AES-GCM",true,["decrypt"]);
        let inner = await crypto.subtle.decrypt({name:"AES-GCM",iv:b64ToA(sIV2)},K2,b64ToA(sE2));

        let K1 = await crypto.subtle.importKey("raw",b64ToA(sK1),"AES-GCM",true,["decrypt"]);
        let plain = await crypto.subtle.decrypt({name:"AES-GCM",iv:b64ToA(sIV1)},K1,inner);

        return JSON.parse(dec.decode(plain));
    } catch(e){
        return null;
    }
}

/* ---------- Light Bot Checks (Safe) ---------- */
function humanCheck(){
    return new Promise(res=>{
        let ok = false;
        let t0 = performance.now();

        window.addEventListener("mousemove",()=>ok=true,{once:true});
        window.addEventListener("touchstart",()=>ok=true,{once:true});

        setTimeout(()=>res(ok || performance.now()-t0>120),150);
    });
}

/* ---------------- Page Logic ---------------- */
window.addEventListener("DOMContentLoaded",()=>{
    const params = new URLSearchParams(location.search);
    const w = params.get("w");

    if(!w){
        document.getElementById("gen").style.display="block";
        return;
    }

    document.getElementById("verify").style.display="flex";

    let verified = false;
    window.onTurnstileSuccess = ()=>{ verified = true; document.getElementById("go").disabled=false; };

    document.getElementById("go").onclick = async ()=>{
        if(!verified) return alert("Please verify first.");
        document.getElementById("go").textContent = "Checking...";

        if(!await humanCheck()) return alert("Bot behavior detected.");

        let payload = await decryptPayload(decodeURIComponent(w));
        if(!payload || !payload.u || payload.domain !== location.hostname){
            document.body.innerHTML="<h1 style='text-align:center;margin-top:20%;color:red;'>Invalid Link</h1>";
            return;
        }

        await new Promise(r=>setTimeout(r(300 + Math.random()*700)));

        location.href = payload.u;
    };
});

/* ---------------- Generator ---------------- */
window.makeLink = async ()=>{
    const u = document.getElementById("url").value.trim();
    if(!u) return alert("Enter URL.");

    const payload = { u, nonce:crypto.randomUUID() };
    const enc = await encryptPayload(payload);

    const link = `${SITE}?w=${encodeURIComponent(enc)}`;
    document.getElementById("out").innerHTML =
        `<p><strong>Generated:</strong><br><a href="${link}" target="_blank">${link}</a></p>`;
};
})();
</script>
</head>

<body>

<!-- Generator -->
<div id="gen" class="box" style="display:none;">
    <h2>Create Protected Redirect</h2>
    <input id="url" type="text" placeholder="https://example.com">
    <button onclick="makeLink()">Generate</button>
    <div id="out" style="margin-top:15px;"></div>
</div>

<!-- Verify Page -->
<div id="verify">
<div id="vBox">
<h2>Verify to Continue</h2>
<div class="cf-turnstile" data-sitekey="0x4AAAAAAB_GRO5x_mAh22NL" data-callback="onTurnstileSuccess"></div>
<button id="go" disabled>Waiting...</button>
</div>
</div>

</body>
</html>
