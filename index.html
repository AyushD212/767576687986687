<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Redirect Generator</title>
<style>
html,body {height:100%; margin:0; padding:0; font-family:Arial,sans-serif; background:#f8f9fa; color:#111;}
.section {border:1px solid #e0e0e0; padding:14px; border-radius:8px; margin:18px auto; max-width:960px; background:#fff;}
input[type="text"] {width:72%; padding:8px; border:1px solid #ccc; border-radius:4px;}
button {padding:8px 12px; border-radius:6px; border:0; background:#0366d6; color:#fff; cursor:pointer;}
.sample {word-break:break-all; color:#0366d6; text-decoration:none;}
#verify-screen {display:none; align-items:center; justify-content:center; height:100vh; background:#f8f9fa;}
#verify-box {background:#fff; padding:30px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,0.1); text-align:center;}
h2 {font-weight:500; margin-bottom:14px;}
.spinner {border:6px solid #f3f3f3; border-top:6px solid #0366d6; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin:auto;}
@keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}
</style>

<!-- Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
// ----------------------- CONFIG -----------------------
const CONFIG = {
    PUBLIC_HOST: window.location.origin + window.location.pathname,
    TURNSTILE_SITE_KEY: '0x4AAAAAAB_GRO5x_mAh22NL'
};
// ------------------------------------------------------

function uuid(){ return crypto.randomUUID ? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2,12); }

// ----------------------- Base64 helpers -----------------------
function arrayBufferToBase64(buffer){
    let binary=''; const bytes=new Uint8Array(buffer);
    for(let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]);
    return btoa(binary);
}
function base64ToArrayBuffer(base64){
    const binary=atob(base64); const bytes=new Uint8Array(binary.length);
    for(let i=0;i<binary.length;i++) bytes[i]=binary.charCodeAt(i);
    return bytes.buffer;
}

// ----------------------- AES helpers -----------------------
async function generateAESKey(){ return crypto.subtle.generateKey({name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]); }
async function encryptPayload(payload){
    const key = await generateAESKey();
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encPayload = new TextEncoder().encode(JSON.stringify(payload));
    const encrypted = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, encPayload);
    const rawKey = await crypto.subtle.exportKey("raw", key);
    return arrayBufferToBase64(encrypted) + '.' + arrayBufferToBase64(iv) + '.' + arrayBufferToBase64(rawKey);
}
async function decryptPayload(encStr){
    try{
        const [encryptedB64, ivB64, keyB64] = encStr.split('.');
        const encrypted = base64ToArrayBuffer(encryptedB64);
        const iv = base64ToArrayBuffer(ivB64);
        const keyRaw = base64ToArrayBuffer(keyB64);
        const key = await crypto.subtle.importKey("raw", keyRaw, "AES-GCM", true, ["decrypt"]);
        const decrypted = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, encrypted);
        return JSON.parse(new TextDecoder().decode(decrypted));
    } catch(e){ return null; }
}

// ----------------------- Dynamic page titles -----------------------
const pageTitles = ["Explore New Horizons","Hidden Journey","Mystery Path","Secret Portal","Adventure Awaits","The Unknown","Secret Passage","Lost Trail","Enchanted Gateway","Whispering Woods"];

// ----------------------- DOM events -----------------------
window.addEventListener('DOMContentLoaded', async ()=>{
    const params = new URLSearchParams(location.search);
    const w = params.get('w');

    if(!w){ 
        document.getElementById('generator').style.display='block'; 
        document.title = pageTitles[Math.floor(Math.random()*pageTitles.length)];
        return; 
    }

    // Show verify screen
    document.getElementById('verify-screen').style.display='flex';
    const btn = document.getElementById('continueBtn'); let verified=false;

    window.onTurnstileSuccess = function(token){ verified=true; btn.disabled=false; btn.textContent='Continue'; };

    btn.addEventListener('click', async ()=>{
        if(!verified){ alert('Please complete the verification first.'); return; }

        // Show spinner
        const box = document.getElementById('verify-box');
        box.innerHTML = `<div class="spinner"></div><p>Redirecting...</p>`;

        // Small delay for UX
        await new Promise(res => setTimeout(res, 1200));

        const payload = await decryptPayload(decodeURIComponent(w));
        if(!payload||!payload.u){ 
            document.body.innerHTML='<p style="text-align:center;color:red;">Invalid or malformed link.</p>'; 
            return; 
        }

        // Set page title dynamically from payload before redirect
        if(payload.r) document.title = `Redirect: ${payload.r}`;

        window.location.href = payload.u;
    });
});

// ----------------------- Link generator -----------------------
async function generateLink(){
    const dest = document.getElementById('targetInput').value.trim();
    if(!dest) return alert('Enter a destination URL.');

    // Double encryption for downloads
    const payload = {u:dest, r:uuid(), t:Date.now()};
    const encLayer1 = await encryptPayload(payload);
    const encLayer2 = await encryptPayload({data:encLayer1});

    const finalURL = `${CONFIG.PUBLIC_HOST}?w=${encodeURIComponent(encLayer2)}`;

    // Generate clean download files
    const svgFile = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="100">
        <rect width="100%" height="100%" fill="#eef"/>
        <text x="20" y="50" font-size="16">Double Encrypted Redirect</text>
        <metadata>${encLayer2}</metadata>
    </svg>`;

    const htmlFile = `<html><body>
        <h2>Double Encrypted Redirect</h2>
        <pre>${encLayer2}</pre>
    </body></html>`;

    const qrFile = await QRCode.toString(finalURL, { type:'svg', width:128 });

    document.getElementById('generated').innerHTML = `
        <button onclick='downloadFile("redirect.svg", \`${svgFile}\`, "image/svg+xml")'>Download SVG</button>
        <button onclick='downloadFile("redirect.html", \`${htmlFile}\`, "text/html")'>Download HTML</button>
        <button onclick='downloadFile("redirectQR.svg", \`${qrFile}\`, "image/svg+xml")'>Download QR</button>
        <button onclick='navigator.clipboard.writeText("${finalURL}")'>Copy Final URL</button>
        <p>Final URL: <a href="${finalURL}" target="_blank">${finalURL}</a></p>
    `;
}

// ----------------------- Download helper -----------------------
function downloadFile(filename, content, type){
    const blob = new Blob([content], {type});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}
</script>

<!-- Generator section -->
<div id="generator" class="section" style="display:none;">
<h2>Generate an encoded redirect link</h2>
<input id="targetInput" type="text" placeholder="Enter destination URL (e.g. https://example.com)" />
<button onclick="generateLink()">Generate</button>
<div id="generated" style="margin-top:12px;"></div>
<div style="margin-top:10px;color:#666;font-size:13px;">
All generated links will start with:<br/>
<code style="word-break:break-all;">${window.location.origin}${window.location.pathname}</code>
</div>
</div>

<!-- Verify screen -->
<div id="verify-screen">
<div id="verify-box">
<h2>Verify to Continue</h2>
<div class="cf-turnstile" data-sitekey="0x4AAAAAAB_GRO5x_mAh22NL" data-callback="onTurnstileSuccess"></div>
<button id="continueBtn" disabled>Waiting for verification...</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</body>
</html>
