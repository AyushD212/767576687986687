<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Encrypted Link Generator</title>
<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; background: #f8f9fa; color: #111; }
.section { border: 1px solid #e0e0e0; padding: 14px; border-radius: 8px; margin: 18px auto; max-width: 960px; background: #fff; }
input[type="text"] { width: 70%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
button { padding: 8px 12px; border-radius: 6px; border: 0; background: #0366d6; color: #fff; cursor: pointer; margin: 4px; }
.sample { word-break: break-all; color: #0366d6; text-decoration: none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
<div class="section">
<h2>Encrypted Link Generator</h2>
<input id="targetInput" type="text" placeholder="Enter destination URL e.g. https://example.com"/>
<button id="generateBtn">Generate</button>
<div id="generated" style="margin-top:12px;"></div>
</div>

<script>
const BASE_URL = window.location.origin + window.location.pathname;

function uuid() {
    return crypto.randomUUID ? crypto.randomUUID() : "id-" + Math.random().toString(36).slice(2,12);
}

function arrayBufferToBase64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
}

async function generateAESKey() {
    return crypto.subtle.generateKey({name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]);
}

async function encryptPayload(payload) {
    const key = await generateAESKey();
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encoded = new TextEncoder().encode(JSON.stringify(payload));
    const encrypted = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, encoded);
    const rawKey = await crypto.subtle.exportKey("raw", key);
    return arrayBufferToBase64(encrypted) + "." + arrayBufferToBase64(iv) + "." + arrayBufferToBase64(rawKey);
}

function generateHTML(encData) {
    return `
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Redirecting...</title></head>
<body><script>
(async()=>{
const str="${encData.replace(/"/g,'\\"')}";
function base64ToArrayBuffer(b){const bin=atob(b);const bytes=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);return bytes.buffer;}
async function decryptPayload(str){try{const [e,iv,k]=str.split(".");const keybuf=base64ToArrayBuffer(k);const encrypted=base64ToArrayBuffer(e);const ivbuf=base64ToArrayBuffer(iv);const key=await crypto.subtle.importKey("raw",keybuf,"AES-GCM",true,["decrypt"]);const decrypted=await crypto.subtle.decrypt({name:"AES-GCM",iv:ivbuf},key,encrypted);return JSON.parse(new TextDecoder().decode(decrypted));}catch(e){return null;}}
const payload=await decryptPayload(str);if(payload && payload.u) window.location.href=payload.u;
})();
<\/script></body></html>`;
}

function generateSVG(encData) {
    return `
<svg xmlns="http://www.w3.org/2000/svg" width="200" height="50">
<rect width="100%" height="100%" fill="#eef"/>
<text x="10" y="30" font-size="14">Encrypted Link</text>
<script type="application/ecmascript"><![CDATA[
(async()=>{
const str="${encData.replace(/"/g,'\\"')}";
function base64ToArrayBuffer(b){const bin=atob(b);const bytes=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);return bytes.buffer;}
async function decryptPayload(str){try{const [e,iv,k]=str.split(".");const keybuf=base64ToArrayBuffer(k);const encrypted=base64ToArrayBuffer(e);const ivbuf=base64ToArrayBuffer(iv);const key=await crypto.subtle.importKey("raw",keybuf,"AES-GCM",true,["decrypt"]);const decrypted=await crypto.subtle.decrypt({name:"AES-GCM",iv:ivbuf},key,encrypted);return JSON.parse(new TextDecoder().decode(decrypted));}catch(e){return null;}}
const payload=await decryptPayload(str);if(payload && payload.u) window.location.href=payload.u;
})();
]]><\/script>
</svg>`;
}

function downloadFile(filename, content, type) {
    const blob = new Blob([content], {type});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

async function generateQRCodeSVG(link) {
    return await QRCode.toString(link, { type:"svg", width:128 });
}

document.getElementById("generateBtn").addEventListener("click", async () => {
    const dest = document.getElementById("targetInput").value.trim();
    if (!dest) { alert("Enter destination URL."); return; }
    const payload = { u: dest, r: uuid(), t: Date.now() };
    const encData = await encryptPayload(payload);
    const finalUrl = BASE_URL + "?w=" + encodeURIComponent(encData);

    const html = generateHTML(encData);
    const svg  = generateSVG(encData);
    const qr   = await generateQRCodeSVG(finalUrl);

    const out = document.getElementById("generated");
    out.innerHTML = `
        <p>Final link:<br><a class="sample" href="${finalUrl}" target="_blank">${finalUrl}</a></p>
        <button id="dl-html">Download HTML</button>
        <button id="dl-svg">Download SVG</button>
        <button id="dl-qr">Download QR</button>
    `;

    document.getElementById("dl-html").onclick = () => downloadFile(uuid()+".html", html, "text/html");
    document.getElementById("dl-svg").onclick  = () => downloadFile(uuid()+".svg", svg, "image/svg+xml");
    document.getElementById("dl-qr").onclick   = () => downloadFile(uuid()+".svg", qr, "image/svg+xml");
});
</script>
</body>
</html>
