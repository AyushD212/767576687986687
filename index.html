<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Redirect Portal</title>

<!-- Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<style>
body,html{margin:0;padding:0;font-family:Arial;background:#f8f9fa;color:#111}
.section{background:#fff;padding:18px;margin:20px auto;max-width:900px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
input[type=text]{width:70%;padding:8px;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;background:#0366d6;color:#fff;border:0;border-radius:6px;cursor:pointer}
.sample{color:#0366d6;word-break:break-all}
#verify-screen{display:none;align-items:center;justify-content:center;height:100vh}
#verify-box{background:#fff;padding:30px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.1);text-align:center}
</style>

<script>
/* -----------------------------------------
   CONFIG
----------------------------------------- */
const CFG = {
    TURN_KEY: "0x4AAAAAAB_GRO5x_mAh22NL",
    PUBLIC_HOST: window.location.origin + window.location.pathname
};

/* -----------------------------------------
   HELPERS
----------------------------------------- */
const TE = new TextEncoder();
const TD = new TextDecoder();

function b64(a){return btoa(a);}
function ub64(a){return atob(a);}
function ab2b64(buf){
    let bin="", bytes=new Uint8Array(buf);
    for(let i=0;i<bytes.length;i++) bin+=String.fromCharCode(bytes[i]);
    return btoa(bin);
}
function b642ab(s){
    let bin=atob(s), len=bin.length, out=new Uint8Array(len);
    for(let i=0;i<len;i++) out[i]=bin.charCodeAt(i);
    return out.buffer;
}
function uuid(){
    return crypto.randomUUID ? crypto.randomUUID() : "id_"+Math.random().toString(36).slice(2,12);
}

/* -----------------------------------------
   AES FUNCTIONS
----------------------------------------- */
async function genAES(){return crypto.subtle.generateKey({name:"AES-GCM",length:256},true,["encrypt","decrypt"]);}

async function encryptPayload(obj){
    obj._pad = Array.from({length:16},()=>Math.floor(Math.random()*256));

    const k1 = await genAES();
    const iv1 = crypto.getRandomValues(new Uint8Array(12));
    const enc1 = await crypto.subtle.encrypt({name:"AES-GCM",iv:iv1},k1,TE.encode(JSON.stringify(obj)));
    const k1raw = await crypto.subtle.exportKey("raw",k1);

    const k2 = await genAES();
    const iv2 = crypto.getRandomValues(new Uint8Array(12));
    const enc2 = await crypto.subtle.encrypt({name:"AES-GCM",iv:iv2},k2,enc1);
    const k2raw = await crypto.subtle.exportKey("raw",k2);

    const pack = [
        ab2b64(enc2),
        ab2b64(iv2),
        ab2b64(k2raw),
        ab2b64(iv1),
        ab2b64(k1raw)
    ].map(s=>b64(s)).join(".");

    return pack;
}

async function decryptPayload(str){
    try{
        let p = str.split(".").map(s=>ub64(s));
        let [e2b,iv2b,k2b,iv1b,k1b] = p;

        const k2raw = b642ab(k2b);
        const k2 = await crypto.subtle.importKey("raw",k2raw,"AES-GCM",true,["decrypt"]);
        const e2 = b642ab(e2b);
        const iv2 = b642ab(iv2b);
        const e1 = await crypto.subtle.decrypt({name:"AES-GCM",iv:iv2},k2,e2);

        const k1raw = b642ab(k1b);
        const k1 = await crypto.subtle.importKey("raw",k1raw,"AES-GCM",true,["decrypt"]);
        const iv1 = b642ab(iv1b);
        const final = await crypto.subtle.decrypt({name:"AES-GCM",iv:iv1},k1,e1);

        return JSON.parse(TD.decode(final));
    }catch(e){
        return null;
    }
}

/* -----------------------------------------
   DEVTOOLS DETECTION â€” SAFE VERSION
----------------------------------------- */
let devtoolsOpen = false;

function checkDevTools(){
    const threshold = 180;
    const w = window.outerWidth - window.innerWidth;
    const h = window.outerHeight - window.innerHeight;
    devtoolsOpen = (w > threshold) || (h > threshold);

    if(devtoolsOpen){
        document.body.innerHTML = `
            <div style="text-align:center;margin-top:20%;">
                <h1 style="color:red;">ACCESS DENIED</h1>
                <p>Developer Tools detected. Close DevTools to continue.</p>
            </div>`;
    }
}

setInterval(checkDevTools, 800);
window.addEventListener("resize", checkDevTools);

/* -----------------------------------------
   PAGE TITLES
----------------------------------------- */
const titles = ["Hidden Path","Mystery Gate","Secret Trail","Obscured Portal","Shadow Route"];
document.title = titles[Math.floor(Math.random()*titles.length)];

/* -----------------------------------------
   GENERATE LINK
----------------------------------------- */
async function generateLink(){
    const d = document.getElementById("target").value.trim();
    if(!d) return alert("Enter a destination URL.");

    const payload = {
        u: d,
        r: uuid(),
        n: Math.random().toString(36).slice(2,10),
        t: Date.now()
    };

    const enc = await encryptPayload(payload);
    const final = `${CFG.PUBLIC_HOST}?w=${encodeURIComponent(enc)}`;

    document.getElementById("output").innerHTML =
        `<p><strong>Generated:</strong><br>
         <a class="sample" href="${final}" target="_blank">${final}</a></p>`;
}

/* -----------------------------------------
   REDIRECT LOGIC
----------------------------------------- */
window.addEventListener("DOMContentLoaded",()=>{
    const params = new URLSearchParams(location.search);
    const w = params.get("w");

    if(!w){
        document.getElementById("gen").style.display="block";
        return;
    }

    document.getElementById("verify-screen").style.display="flex";

    let ok = false;
    window.onTurnstileSuccess = function(){ ok = true; document.getElementById("go").disabled=false; };

    document.getElementById("go").addEventListener("click", async ()=>{
        if(devtoolsOpen) return;
        if(!ok){ alert("Please complete verification."); return; }

        document.getElementById("go").disabled = true;
        document.getElementById("go").textContent = "Checking...";

        const p = await decryptPayload(decodeURIComponent(w));
        if(!p || !p.u){
            document.body.innerHTML =
                "<h1 style='text-align:center;margin-top:20%;color:red;'>Invalid Link</h1>";
            return;
        }

        await new Promise(res=>setTimeout(res, 600 + Math.random()*500));
        if(devtoolsOpen) return;

        window.location.href = p.u;
    });
});
</script>
</head>

<body>

<!-- Generator -->
<div id="gen" class="section" style="display:none;">
    <h2>Generate Secure Redirect</h2>
    <input id="target" type="text" placeholder="Enter URL (e.g. https://example.com)">
    <button onclick="generateLink()">Generate</button>
    <div id="output" style="margin-top:15px;"></div>
    <p style="font-size:12px;color:#666;">Links start with:<br>
    <code>${window.location.origin}${window.location.pathname}</code></p>
</div>

<!-- Redirect Screen -->
<div id="verify-screen">
    <div id="verify-box">
        <h2>Verify to Continue</h2>
        <div class="cf-turnstile"
             data-sitekey="0x4AAAAAAB_GRO5x_mAh22NL"
             data-callback="onTurnstileSuccess"></div>
        <button id="go" disabled>Waiting...</button>
    </div>
</div>

</body>
</html>
