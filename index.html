<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Secure Redirect</title>

<!-- Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<style>
body,html{margin:0;padding:0;background:#f8f9fa;font-family:Arial}
.box{background:#fff;max-width:900px;margin:30px auto;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
input[type=text]{padding:8px;width:70%;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;border:0;background:#0366d6;color:#fff;border-radius:6px;cursor:pointer}
a{color:#0366d6;word-break:break-all}
#verify{display:none;align-items:center;justify-content:center;height:100vh}
#vBox{background:#fff;padding:30px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.1);text-align:center}
</style>

<script>
(() => {

const encoder = new TextEncoder();
const decoder = new TextDecoder();

/* ---------------- Trusted Domains ---------------- */
const TRUSTED_DOMAINS = [
    "yourdomain.com",
    "anotherdomain.net"
];

/* ----------- SHA‑256 integrity hash ------------ */
async function sha256(str){
    const data = encoder.encode(str);
    const hash = await crypto.subtle.digest("SHA-256", data);
    return btoa(String.fromCharCode(...new Uint8Array(hash)));
}

/* ----------- Random Query Param Name ----------- */
function randomParam(){
    return crypto.randomUUID().replace(/-/g,"").slice(0,10);
}

/* ----------- Generator Logic ----------- */
window.makeLink = async () => {
    const target = document.getElementById("url").value.trim();
    if(!target) return alert("Enter URL.");

    // Payload is NOT hidden — only preserved
    const payload = JSON.stringify({
        u: target,
        d: TRUSTED_DOMAINS,
        ts: Date.now()
    });

    const checksum = await sha256(payload);

    const param = randomParam();
    const SITE = window.location.origin + window.location.pathname;

    const url = `${SITE}?${param}=${encodeURIComponent(btoa(payload))}&sig=${checksum}`;

    document.getElementById("out").innerHTML =
        `<p><strong>Generated:</strong><br><a href="${url}" target="_blank">${url}</a></p>`;
};

/* --------- Validate & Redirect -------- */
async function validateAndRedirect(payload, sig){

    const computed = await sha256(payload);
    if(computed !== sig) return false;

    const obj = JSON.parse(atob(payload));

    if(!obj.u) return false;

    // domain whitelist check
    let ok = false;
    for(const d of obj.d){
        if(location.hostname.includes(d)){
            ok = true;
            break;
        }
    }
    if(!ok) return false;

    // micro-interaction check (allowed)
    let human = false;
    const t0 = performance.now();
    window.addEventListener("mousemove", () => human = true, {once:true});
    await new Promise(r => setTimeout(r,150));

    if(!human && performance.now() - t0 < 120) return false;

    return obj.u;
}

/* ----------- Page Init ----------- */
window.addEventListener("DOMContentLoaded", async () => {

    const params = new URLSearchParams(location.search);
    if(params.toString() === ""){
        document.getElementById("gen").style.display = "block";
        return;
    }

    document.getElementById("verify").style.display = "flex";

    let verified = false;
    window.onTurnstileSuccess = () => {
        verified = true;
        document.getElementById("go").disabled = false;
    };

    document.getElementById("go").onclick = async () => {
        if(!verified) return alert("Please verify first.");

        const entries = [...params.entries()];
        const sig = params.get("sig");

        // find the *random* param
        const [key, val] = entries.find(e => e[0] !== "sig");

        const target = await validateAndRedirect(val, sig);

        if(!target){
            document.body.innerHTML =
                "<h1 style='text-align:center;margin-top:20%;color:red;'>Invalid Link</h1>";
            return;
        }

        // small human-like delay
        await new Promise(r => setTimeout(r, 300 + Math.random()*400));

        location.href = target;
    };

});

})();
</script>

</head>

<body>

<!-- Generator -->
<div id="gen" class="box" style="display:none;">
    <h2>Create Protected Redirect</h2>
    <input id="url" type="text" placeholder="https://example.com">
    <button onclick="makeLink()">Generate</button>
    <div id="out" style="margin-top:15px;"></div>
</div>

<!-- Verification Page -->
<div id="verify">
    <div id="vBox">
        <h2>Verify to Continue</h2>
        <div class="cf-turnstile" data-sitekey="0x4AAAAAAB_GRO5x_mAh22NL"
             data-callback="onTurnstileSuccess"></div>
        <button id="go" disabled>Waiting...</button>
    </div>
</div>

</body>
</html>
